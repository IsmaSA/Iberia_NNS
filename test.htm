<!DOCTYPE html>
<html>
<head>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
</head>
<body>
  <div id="map" style="height: 600px;"></div>

  <!-- YOUR SCRIPT BELOW -->
  <script>
    // 1) Initialize the map
    const map = L.map('map').setView([40.0, -3.7], 6);

    // 2) Add a base layer (e.g., OSM)
    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    });
    osmLayer.addTo(map);

    // 3) Create a marker cluster group for Portugal
    const portugalCluster = L.markerClusterGroup();

    // 4) Define a function to fetch from Zenodo
    function loadJsonDataFromZenodo(fileUrl, clusterGroup) {
      fetch(fileUrl, { cache: "no-cache" })
        .then(response => {
          if (!response.ok) {
            throw new Error(`Failed to load ${fileUrl}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          // Check that data is an array
          if (!Array.isArray(data)) {
            console.error("Data is not an array:", data);
            return;
          }

          // Loop through each record
          data.forEach(point => {
            if (point.decimalLatitude && point.decimalLongitude) {
              const marker = L.marker([point.decimalLatitude, point.decimalLongitude])
                .bindPopup(`<b>Species:</b> ${point.species}`);
              clusterGroup.addLayer(marker);
            }
          });

          // Add cluster group to map
          map.addLayer(clusterGroup);
        })
        .catch(err => console.error(`Error loading ${fileUrl}: ${err}`));
    }

    // 5) Actually call the function with your Zenodo link
    loadJsonDataFromZenodo(
      'https://zenodo.org/records/15008998/files/Iberia_PT.json?download=1',
      portugalCluster
    );

    // OPTIONAL: If you want layer control
    const baseLayers = {
      "OpenStreetMap": osmLayer
    };
    const overlays = {
      "Portugal": portugalCluster
    };
    L.control.layers(baseLayers, overlays).addTo(map);

  </script>
</body>
</html>
